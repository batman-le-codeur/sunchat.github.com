<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sun — Assistant IA</title>
<style>
  :root{
    --primary: #fb923c;
    --primary-hover: #ea8029;
    --secondary: #ec4899;
    --bg-main: #ffffff;
    --bg-secondary: #f8fafc;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --border: #e5e7eb;
    --border-light: #f3f4f6;
  }
  
  *{
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg-main);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-main);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .header-left{
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .logo{
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .logo svg{
    width: 20px;
    height: 20px;
    color: white;
  }
  
  .title{
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .subtitle{
    font-size: 14px;
    color: var(--text-secondary);
    margin-left: 8px;
  }

  .chat-container{
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 768px;
    margin: 0 auto;
    width: 100%;
  }

  .chat-area{
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .welcome-message{
    text-align: center;
    padding: 48px 24px;
    color: var(--text-secondary);
  }
  
  .welcome-title{
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  
  .welcome-subtitle{
    font-size: 16px;
    margin-bottom: 16px;
  }
  
  .welcome-example{
    font-size: 14px;
    background: var(--bg-secondary);
    padding: 12px 16px;
    border-radius: 8px;
    display: inline-block;
    border: 1px solid var(--border-light);
  }

  .message-group{
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .message{
    display: flex;
    gap: 12px;
    max-width: 100%;
  }
  
  .message.user{
    flex-direction: row-reverse;
  }
  
  .message-avatar{
    width: 32px;
    height: 32px;
    border-radius: 16px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 500;
    margin-top: 4px;
  }
  
  .message.user .message-avatar{
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  
  .message.bot .message-avatar{
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
  }
  
  .message-content{
    min-width: 0;
  }
  
  .message-bubble{
    padding: 12px 16px;
    border-radius: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    display: inline-block;
    max-width: 100%;
  }
  
  .message.user .message-bubble{
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    margin-left: 48px;
    max-width: 75%;
  }
  
  .message.bot .message-bubble{
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    margin-right: 48px;
    max-width: 85%;
  }
  
  .typing-indicator{
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-secondary);
    font-style: italic;
    padding: 12px 16px;
  }
  
  .typing-dots{
    display: flex;
    gap: 4px;
  }
  
  .typing-dot{
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-secondary);
    animation: typing 1.4s infinite;
  }
  
  .typing-dot:nth-child(2){ animation-delay: 0.2s; }
  .typing-dot:nth-child(3){ animation-delay: 0.4s; }

  .input-area{
    border-top: 1px solid var(--border);
    background: var(--bg-main);
    padding: 16px 24px;
    position: sticky;
    bottom: 0;
  }
  
  .input-container{
    display: flex;
    gap: 12px;
    align-items: flex-end;
    max-width: 768px;
    margin: 0 auto;
  }
  
  .input-wrapper{
    flex: 1;
    position: relative;
  }
  
  textarea{
    width: 100%;
    min-height: 132px;
    max-height: 200px;
    padding: 12px 16px 40px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    resize: none;
    outline: none;
    background: var(--bg-main);
    color: var(--text-primary);
    line-height: 1.4;
  }
  
  textarea:focus{
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.1);
  }
  
  textarea::placeholder{
    color: var(--text-secondary);
  }
  
  .version-label{
    position: absolute;
    bottom: 8px;
    right: 12px;
    font-size: 10px;
    font-weight: 500;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    pointer-events: none;
    user-select: none;
  }
  
  .send-button{
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  .send-button:hover:not(:disabled){
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
  }
  
  .send-button:disabled{
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  @keyframes typing{
    0%, 60%, 100%{ transform: translateY(0); opacity: 0.4; }
    30%{ transform: translateY(-10px); opacity: 1; }
  }
  
  @media (max-width: 768px){
    .header{
      padding: 12px 16px;
    }
    
    .chat-area{
      padding: 16px;
      gap: 16px;
    }
    
    .message.user .message-bubble{
      margin-right: 24px;
      margin-left: auto;
    }
    
    .message.bot .message-bubble{
      margin-left: 24px;
    }
    
    .input-area{
      padding: 12px 16px;
    }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="4"/>
        <path d="M12 2v2"/>
        <path d="M12 20v2"/>
        <path d="M2 12h2"/>
        <path d="M20 12h2"/>
        <path d="M4.5 4.5l1.4 1.4"/>
        <path d="M18.1 18.1l1.4 1.4"/>
        <path d="M4.5 19.5l1.4-1.4"/>
        <path d="M18.1 5.9l1.4-1.4"/>
      </svg>
    </div>
    <div>
      <span class="title">Sun</span>
      <span class="subtitle">Assistant IA</span>
    </div>
  </div>
</div>

<div class="chat-container">
  <div class="chat-area" id="chat">
    <div class="welcome-message">
      <div class="welcome-title">Bonjour ! 👋</div>
      <div class="welcome-subtitle">Je suis <strong>Sun</strong>, votre assistant IA. Comment puis-je vous aider aujourd'hui ?</div>
      <div class="welcome-example">💡 Exemple : "Quel temps fait-il à Libreville ?"</div>
    </div>
  </div>
  
  <div class="input-area">
    <div class="input-container">
      <div class="input-wrapper">
        <textarea 
          id="input" 
          placeholder="Écrivez votre message..."
          rows="1"
        ></textarea>
        <div class="version-label">Sun chatIA V5</div>
      </div>
      <button class="send-button" id="send" type="button" aria-label="Envoyer">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22,2 15,22 11,13 2,9"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // === CONFIG ===
  const WEBHOOK_URL = "https://anbgtest.app.n8n.cloud/webhook/sun";

  // === UTIL ===
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send');

  // Auto-resize textarea
  input.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    updateSendButton();
  });

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function addMessage(text, isUser = false) {
    // Remove welcome message if present
    const welcome = document.querySelector('.welcome-message');
    if (welcome) {
      welcome.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    
    if (isUser) {
      avatar.textContent = 'U';
    } else {
      avatar.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="4"/>
          <path d="M12 2v2"/>
          <path d="M12 20v2"/>
          <path d="M2 12h2"/>
          <path d="M20 12h2"/>
          <path d="M4.5 4.5l1.4 1.4"/>
          <path d="M18.1 18.1l1.4 1.4"/>
          <path d="M4.5 19.5l1.4-1.4"/>
          <path d="M18.1 5.9l1.4-1.4"/>
        </svg>
      `;
    }

    const content = document.createElement('div');
    content.className = 'message-content';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = escapeHtml(text).replace(/\n/g, '<br/>');
    
    content.appendChild(bubble);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    chat.appendChild(messageDiv);
    chat.scrollTop = chat.scrollHeight;
    
    return messageDiv;
  }

  let typingMessage = null;
  function showTyping() {
    if (typingMessage) return;
    
    const welcome = document.querySelector('.welcome-message');
    if (welcome) {
      welcome.remove();
    }

    typingMessage = document.createElement('div');
    typingMessage.className = 'message bot';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="4"/>
        <path d="M12 2v2"/>
        <path d="M12 20v2"/>
        <path d="M2 12h2"/>
        <path d="M20 12h2"/>
        <path d="M4.5 4.5l1.4 1.4"/>
        <path d="M18.1 18.1l1.4 1.4"/>
        <path d="M4.5 19.5l1.4-1.4"/>
        <path d="M18.1 5.9l1.4-1.4"/>
      </svg>
    `;

    const content = document.createElement('div');
    content.className = 'message-content';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = `
      <div class="typing-indicator">
        Sun réfléchit
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    `;
    
    content.appendChild(bubble);
    typingMessage.appendChild(avatar);
    typingMessage.appendChild(content);
    
    chat.appendChild(typingMessage);
    chat.scrollTop = chat.scrollHeight;
  }

  function removeTyping() {
    if (typingMessage) {
      typingMessage.remove();
      typingMessage = null;
    }
  }

  function updateSendButton() {
    const hasText = input.value.trim().length > 0;
    sendBtn.disabled = !hasText || input.disabled;
  }

  function setInputState(disabled) {
    input.disabled = disabled;
    updateSendButton();
  }

  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  updateSendButton();

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    
    addMessage(text, true);
    input.value = '';
    input.style.height = 'auto';
    setInputState(true);
    showTyping();

    const payload = { 
      question: text, 
      source: "web-client", 
      ts: new Date().toISOString() 
    };

    try {
      console.log('POST ->', WEBHOOK_URL, payload);
      const res = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'cors'
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} - ${txt || res.statusText}`);
      }

      const ct = res.headers.get('content-type') || '';
      let data;
      if (ct.includes('application/json')) {
        data = await res.json();
      } else {
        const txt = await res.text();
        try { 
          data = JSON.parse(txt); 
        } catch { 
          data = { answer: txt }; 
        }
      }

      removeTyping();
      const answer = (data && (data.answer || data.output || data.text || data.msg)) || JSON.stringify(data);
      addMessage(answer, false);
      console.log('RESPONSE <-', data);

    } catch (err) {
      removeTyping();
      console.error('Envoi échoué:', err);
      
      const message = `Erreur de connexion : ${err.message}`;
        
      addMessage(`⚠️ ${message}`, false);
      console.warn('Vérifiez la configuration du webhook et les paramètres CORS.');
      
    } finally {
      setInputState(false);
    }
  }
</script>
</body>
</html>